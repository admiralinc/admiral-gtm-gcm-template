___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Admiral Consent Manager",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAAD6CAYAAACI7Fo9AAAACXBIWXMAAC4jAAAuIwF4pT92AAAGX2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDg4LCAyMDIwLzA3LzEwLTIyOjA2OjUzICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjIuMCAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjAtMTAtMjlUMTU6MDY6MDktMDQ6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDIwLTEwLTI5VDE1OjA2OjQ1LTA0OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTEwLTI5VDE1OjA2OjQ1LTA0OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOmVjYTBkYzkxLWRlZDItNDYyMy04MjE3LTU1YTczOWYzMTUzOCIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjFlNmEyMWEwLTFiYjUtYTI0My1hNzUxLTBjZDQzZjQzNTEyZCIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOmI2Mjk2MGUxLTVhYzItNDljNC1iOThiLWU1ZWExZjA3NWUwMiI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6YjYyOTYwZTEtNWFjMi00OWM0LWI5OGItZTVlYTFmMDc1ZTAyIiBzdEV2dDp3aGVuPSIyMDIwLTEwLTI5VDE1OjA2OjA5LTA0OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjIuMCAoTWFjaW50b3NoKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0iY29udmVydGVkIiBzdEV2dDpwYXJhbWV0ZXJzPSJmcm9tIGFwcGxpY2F0aW9uL3ZuZC5hZG9iZS5waG90b3Nob3AgdG8gaW1hZ2UvcG5nIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDplY2EwZGM5MS1kZWQyLTQ2MjMtODIxNy01NWE3MzlmMzE1MzgiIHN0RXZ0OndoZW49IjIwMjAtMTAtMjlUMTU6MDY6NDUtMDQ6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCAyMi4wIChNYWNpbnRvc2gpIiBzdEV2dDpjaGFuZ2VkPSIvIi8+IDwvcmRmOlNlcT4gPC94bXBNTTpIaXN0b3J5PiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PtdQ4UUAABIESURBVHja7Z3LsaVIDkDLgFlgAtuKmMVd9ZqIcYD9bIi2ABPwABMwARMwARMwgU3t70BPvm6Kdz9wyY+UeRShRX+q3gukg5SSUvz4gaiTn3/eC6P1os2i7aLDRu8Xdft3teZn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"
  },
  "description": "This template integrates Admiral\u0027s CMP API with consent mode in Google Tag Manager.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "CHECKBOX",
    "name": "ads_data_redaction",
    "checkboxText": "Redact Ads Data",
    "simpleValueType": true
  },
  {
    "type": "PARAM_TABLE",
    "name": "defaultSettings",
    "displayName": "Default Settings",
    "paramTableColumns": [
      {
        "param": {
          "type": "CHECKBOX",
          "name": "adConsentGranted",
          "checkboxText": "ad_storage granted",
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "CHECKBOX",
          "name": "adUserData",
          "checkboxText": "ad_user_data granted",
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "CHECKBOX",
          "name": "adPersonalization",
          "checkboxText": "ad_personalization granted",
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "CHECKBOX",
          "name": "analyticsConsentGranted",
          "checkboxText": "analytics_storage granted",
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "CHECKBOX",
          "name": "personalizationConsentGranted",
          "checkboxText": "personalization_storage granted",
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "CHECKBOX",
          "name": "functionalityConsentGranted",
          "checkboxText": "functionality_storage granted",
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "CHECKBOX",
          "name": "securityConsentGranted",
          "checkboxText": "security_storage granted",
          "simpleValueType": true
        },
        "isUnique": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// The first two lines are optional, use if you want to enable logging
const log = require("logToConsole");
log("data =", data);
const setDefaultConsentState = require("setDefaultConsentState");
const updateConsentState = require("updateConsentState");
const callInWindow = require("callInWindow");
const getCookieValues = require("getCookieValues");
const gtagSet = require("gtagSet");
const createQueue = require("createQueue");
const COOKIE_NAME = 'gtmc';

const dataLayerPush = createQueue("dataLayer");

const parseConsentState = (consent) => ({    
    ad_storage: consent.adConsentGranted ? "granted" : "denied",
    analytics_storage: consent.analyticsConsentGranted ? "granted" : "denied",
    functionality_storage: consent.functionalityConsentGranted ? "granted" : "denied",
    personalization_storage: consent.personalizationConsentGranted ? "granted" : "denied",
    security_storage: consent.securityConsentGranted ? "granted" : "denied",
    ad_user_data: consent.adUserData ? "granted" : "denied",
    ad_personalization: consent.adPersonalization ? "granted" : "denied"
  });

/**
 * Called when consent changes. Assumes that consent object contains keys which
 * directly correspond to Google consent types.
 */
const onUserConsent = (consent) => {
  const consentModeStates = parseConsentState(consent);
  updateConsentState(consentModeStates);
  dataLayerPush({ event: "admiral.consent.updated" });
};

/**
 * Executes the default command, sets the developer ID, and sets up the consent
 * update callback
 */
const main = (data) => {
  gtagSet({'developer_id.dYzhhYT': true });
  const defaultConsent = data.defaultSettings ? parseConsentState(data.defaultSettings) : {
    ad_storage: "denied",
    analytics_storage: "denied",
    functionality_storage: "denied",
    personalization_storage: "denied",
    security_storage: "denied",
    ad_user_data: "denied",
    ad_personalization: "denied",
  };
  defaultConsent.wait_for_update = 500;
  setDefaultConsentState(defaultConsent);
  gtagSet("ads_data_redaction", data.ads_data_redaction);

  /**
   *  Check if cookie is set and has values that correspond to Google consent
   *  types. If it does, run onUserConsent().
   */

  const cData = getCookieValues(COOKIE_NAME);
  if (typeof cData !== "undefined") {
    onUserConsent(cData);
  }

  /**
   * Add event listener to trigger update when consent changes
   *
   * References an external method on the window object which accepts a
   * function as an argument. If you do not have such a method, you will need
   * to create one before continuing. This method should add the function
   * that is passed as an argument as a callback for an event emitted when
   * the user updates their consent. The callback should be called with an
   * object containing fields that correspond to the five built-in Google
   * consent types.
   */
  callInWindow("__admiral_getConsentForGTM", onUserConsent);
};
main(data);
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__admiral_getConsentForGTM"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "developer_id.*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "gtmc"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: No consent data
  code: |-
    const mockData = {};

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('setDefaultConsentState').wasCalledWith({
        wait_for_update: 500,
        ad_storage: "denied",
        analytics_storage: "denied",
        functionality_storage: "denied",
        personalization_storage: "denied",
        security_storage: "denied",
        ad_user_data: "denied",
        ad_personalization: "denied",
    });
- name: Consent Data denied
  code: |-
    const mockData = {
      defaultSettings: {
        adConsentGranted: false,
        analyticsConsentGranted: false,
        functionalityConsentGranted: false,
        personalizationConsentGranted: false,
        securityConsentGranted: false,
        adUserData: false,
        adPersonalization: false
      }
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('setDefaultConsentState').wasCalledWith({
        wait_for_update: 500,
        ad_storage: "denied",
        analytics_storage: "denied",
        functionality_storage: "denied",
        personalization_storage: "denied",
        security_storage: "denied",
        ad_user_data: "denied",
        ad_personalization: "denied"
    });
- name: Consent Data granted
  code: |-
    const mockData = {
      defaultSettings: {
        adConsentGranted: true,
        analyticsConsentGranted: true,
        functionalityConsentGranted: true,
        personalizationConsentGranted: true,
        securityConsentGranted: true,
        adUserData: true,
        adPersonalization: true
      }
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('setDefaultConsentState').wasCalledWith({
        wait_for_update: 500,
        ad_storage: "granted",
        analytics_storage: "granted",
        functionality_storage: "granted",
        personalization_storage: "granted",
        security_storage: "granted",
        ad_user_data: "granted",
        ad_personalization: "granted"
    });
- name: Consent data granted + denied
  code: |-
    const mockData = {
      defaultSettings: {
        adConsentGranted: true,
        analyticsConsentGranted: false,
        functionalityConsentGranted: true,
        personalizationConsentGranted: true,
        securityConsentGranted: false,
        adUserData: true,
        adPersonalization: true
      }
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('setDefaultConsentState').wasCalledWith({
        wait_for_update: 500,
        ad_storage: "granted",
        analytics_storage: "denied",
        functionality_storage: "granted",
        personalization_storage: "granted",
        security_storage: "denied",
        ad_user_data: "granted",
        ad_personalization: "granted"
    });


___NOTES___

Created on 3/13/2024, 12:56:05 PM


